name: Continuous Build and Latest Release

on:
  push:
    branches:
      - main
    # Ignore tags to avoid conflicts with release.yml
    tags-ignore:
      - "v*.*.*"
      - "release-*"
  pull_request:
    branches:
      - main

jobs:
  build-and-update-latest:
    runs-on: ubuntu-latest
    container:
      image: texlive/texlive:latest

    permissions:
      contents: write # Required for creating/updating releases
      checks: write # Required for status checks

    steps:
      - name: Install dependencies
        run: |
          apt-get update -y
          apt-get install -y inkscape git make

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Configure git safe directory
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Get build information
        id: build_info
        shell: bash
        run: |
          echo "TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> "$GITHUB_OUTPUT"
          echo "DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_OUTPUT"
          echo "SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-8)" >> "$GITHUB_OUTPUT"
          echo "BRANCH=$(echo $GITHUB_REF | sed 's|refs/heads/||')" >> "$GITHUB_OUTPUT"

          # Get commit message
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          echo "COMMIT_MSG=${COMMIT_MSG}" >> "$GITHUB_OUTPUT"

          # Get author
          AUTHOR=$(git log -1 --pretty=%an)
          echo "AUTHOR=${AUTHOR}" >> "$GITHUB_OUTPUT"

      - name: Build document
        run: make compile

      - name: Verify PDF creation
        run: |
          if [ ! -f Output/Main.pdf ]; then
            echo "::error::PDF was not created - build failed"
            exit 1
          fi

      - name: Prepare PDF for upload
        run: |
          # Copy the PDF with a consistent name for the release
          cp Output/Main.pdf "Report_Latest.pdf"

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## ðŸ”„ Latest Development Build

          **Build Date:** ${{ steps.build_info.outputs.DATE }}
          **Commit:** [`${{ steps.build_info.outputs.SHORT_SHA }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Branch:** `${{ steps.build_info.outputs.BRANCH }}`
          **Author:** ${{ steps.build_info.outputs.AUTHOR }}

          ### ðŸ“ Last Commit Message
          ```
          ${{ steps.build_info.outputs.COMMIT_MSG }}
          ```

          ### ðŸ“¦ Download Files
          - `Report_Latest.pdf` - The latest compiled document

          ---
          *This release is automatically updated with each successful build on the `${{ steps.build_info.outputs.BRANCH }}` branch.*
          *Last updated: ${{ steps.build_info.outputs.DATE }}*
          EOF

      - name: Delete existing Latest release
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const latestRelease = releases.find(release => release.tag_name === 'latest');

              if (latestRelease) {
                console.log('Found existing Latest release, deleting...');

                // Delete the release
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: latestRelease.id
                });

                // Delete the tag
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: 'tags/latest'
                  });
                } catch (e) {
                  console.log('Tag might not exist or already deleted');
                }

                console.log('âœ… Cleaned up existing Latest release');
              } else {
                console.log('No existing Latest release found');
              }
            } catch (error) {
              console.log('Error during cleanup:', error.message);
            }
        continue-on-error: true

      - name: Create or Update Latest Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "ðŸ”„ Latest Development Build"
          body_path: release_notes.md
          files: Report_Latest.pdf
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-${{ steps.build_info.outputs.SHORT_SHA }}
          path: Report_Latest.pdf
          retention-days: 30
          if-no-files-found: error

      - name: Post build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“„ Build Summary

          ## âœ… Build Successful!

          | Property | Value |
          |----------|-------|
          | **PDF Size** | $(du -h Output/Main.pdf | cut -f1) |
          | **Commit** | \`${{ steps.build_info.outputs.SHORT_SHA }}\` |
          | **Branch** | \`${{ steps.build_info.outputs.BRANCH }}\` |
          | **Timestamp** | ${{ steps.build_info.outputs.DATE }} |

          ### ðŸ“¦ Downloads
          - [Latest Release](https://github.com/${{ github.repository }}/releases/tag/latest)
          - [Direct PDF Download](https://github.com/${{ github.repository }}/releases/latest/download/Report_Latest.pdf)

          EOF

      - name: Set commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const description = status === 'success'
              ? 'Document built successfully'
              : 'Document build failed';

            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: status,
                description: description,
                context: 'continuous-build/latex'
              });
            } catch (error) {
              console.log('Could not create commit status:', error.message);
              // This is not critical, so we don't fail the job
            }

  # Separate job for PR comments
  pr-comment:
    runs-on: ubuntu-latest
    needs: build-and-update-latest
    if: github.event_name == 'pull_request'

    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âœ… LaTeX Build Successful

            The document has been successfully built for this pull request.

            **Preview:** [Download Latest PDF](https://github.com/${{ github.repository }}/releases/latest/download/Report_Latest.pdf)

            <details>
            <summary>Build Details</summary>

            - **Commit:** \`${context.sha.substring(0, 8)}\`
            - **Workflow Run:** [#${context.runNumber}](https://github.com/${{ github.repository }}/actions/runs/${context.runId})

            </details>`;

            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('LaTeX Build')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
